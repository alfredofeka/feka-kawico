<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FEKA KAWIÇO - Curso de Inglês (Base)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root{
      --feka-blue:#004a80;
      --feka-yellow:#ffd24d;
      --bg:#f4fbff;
      --card:#ffffff;
      --muted:#444;
      --radius:14px;
      --shadow:0 10px 30px rgba(6,30,60,0.08);
      --accent:#1a6aa8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:linear-gradient(180deg, var(--bg),#fff);
      color:#123;
      -webkit-font-smoothing:antialiased;
    }
    header{
      background:var(--feka-blue);
      color:#fff;
      padding:12px 18px;
      position:sticky;
      top:0;
      z-index:60;
      box-shadow:0 6px 20px rgba(0,0,0,0.12)
    }
    .hdr{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      align-items:center
    }
    .brand{display:flex;align-items:center}
    .brand img{height:36px;margin-right:10px}
    .brand h1{margin:0;font-size:1.4em;font-weight:900;line-height:1}
    nav a, nav button{
      color:#fff;
      text-decoration:none;
      margin-left:18px;
      font-weight:600;
      padding:5px 10px;
      border-radius:var(--radius)
    }
    nav button{
      border:none;
      cursor:pointer;
      background:var(--feka-yellow);
      color:var(--feka-blue);
      transition:background 0.2s;
    }
    nav button:hover{background:#ffc72a}

    main{
      max-width:1200px;
      margin:20px auto;
      padding:0 18px;
      display:grid;
      grid-template-columns:320px 1fr;
      gap:20px;
    }
    .sidebar{
      display:block;
      padding:15px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      height: calc(100vh - 120px);
      overflow:auto;
    }
    .content{
      background:var(--card);
      padding:25px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      min-height:400px;
    }
    .title{
      font-size:1.6em;
      font-weight:900;
      color:var(--accent);
      margin-bottom:6px;
    }
    .muted{color:var(--muted)}

    /* Accordion */
    .module{
      border-radius:10px;
      border:1px solid #eee;
      margin-bottom:10px;
      overflow:hidden;
    }
    .module-header{
      background:#fff;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    .module-title{font-weight:800;color:var(--feka-blue)}
    .module-body{display:none;padding:8px 12px;background:#fafafa;border-top:1px solid #eee}
    .lesson-item{
      padding:8px;
      border-radius:10px;
      margin-bottom:6px;
      background:transparent;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .lesson-item:hover{background:#f0f0f0}
    .lesson-item.active{background:var(--feka-blue);color:#fff}
    .small{font-size:0.9em;color:var(--muted)}

    .controls {
      margin-top:12px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      padding:8px 12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{background:var(--feka-yellow);color:var(--feka-blue)}
    .btn.ghost{background:#f0f0f0;color:var(--feka-blue)}
    .btn.link{background:none;color:var(--feka-blue);padding:6px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;justify-content:center;align-items:center;z-index:200;}
    .modal{background:#fff;padding:18px;border-radius:12px;max-width:420px;width:100%;box-shadow:var(--shadow)}
    .modal h3{margin:0 0 8px 0;color:var(--feka-blue)}
    .input{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px}

    /* footer */
    footer{ text-align:center;padding:20px;margin-top:30px;font-size:0.8em;color:var(--muted) }

    /* teacher bubble */
    .teacher-anim{
      position:fixed;
      right:30px;
      bottom:30px;
      z-index:150;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .teacher-body{cursor:pointer;border-radius:16px;padding:8px;background:linear-gradient(180deg,#1a6aa8,#154f76);color:#fff;box-shadow:var(--shadow)}
    .teacher-bubble{display:none;background:#fff;padding:10px;border-radius:10px;box-shadow:var(--shadow);max-width:220px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="hdr">
      <div class="brand">
        <img src="FK.png" alt="FEKA" onerror="this.style.display='none'">
        <div>
          <h1>FEKA KAWIÇO</h1>
          <div style="font-size: 13px">Curso de Inglês — Base</div>
        </div>
      </div>
      <nav>
        <a href="#" class="small">Planos</a>
        <a href="#" class="small">Comunidade</a>
        <button class="btn ghost" id="btnShowValidate">Validar Curso</button>
        <button class="btn primary" id="btnDashboard" style="display:none"><i class="fa-solid fa-chart-line"></i> Ir para Dashboard</button>
      </nav>
    </div>
  </header>

  <main>
    <aside class="sidebar" id="sidebar">
      <div style="font-weight:900;color:var(--accent);margin-bottom:8px">Módulos</div>
      <div id="modulesContainer"></div>

      <div style="margin-top:14px;border-top:1px solid #eee;padding-top:10px">
        <div style="font-weight:700">Estado</div>
        <div class="small" id="validationStatus">Curso não validado</div>
        <div style="margin-top:8px" class="small">Usuário: <span id="fekaUserLabel">—</span></div>
      </div>
    </aside>

    <section class="content">
      <div class="title" id="lessonTitle">Selecione um módulo / aula</div>
      <div class="small muted" id="lessonMeta">Módulo • Aula</div>

      <div style="margin-top:12px" id="lessonText">Clique numa aula à esquerda para ver o conteúdo. O professor lê em voz alta quando clicas no ícone de áudio.</div>

      <div class="controls" style="margin-top:18px">
        <button class="btn primary" id="btnReadAloud" disabled><i class="fa-solid fa-volume-high"></i> Ouvir Aula</button>
        <button class="btn ghost" id="btnMarkComplete" disabled>Marcar como Concluída</button>
      </div>
    </section>
  </main>

  <footer>&copy; 2025 FEKA KAWIÇO. Todos os direitos reservados.</footer>

  <!-- Teacher floating -->
  <div class="teacher-anim" id="teacherAnim">
    <div class="teacher-bubble" id="teacherBubble">Olá! Clique no ícone para ouvir a aula.</div>
    <div class="teacher-body" id="teacherBody"><i class="fa-solid fa-chalkboard-teacher"></i> Professor</div>
  </div>

  <!-- Modal de Validação -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Validar Curso — Código de Ativação</h3>
      <p class="small muted">Insere o código de ativação para desbloquear o curso (ex: PRC-2025-001 ou ING-2025-001)</p>
      <input id="codeInput" class="input" placeholder="Código de ativação">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="closeModal">Cancelar</button>
        <button class="btn primary" id="submitCode">Validar</button>
      </div>
      <div id="modalMsg" class="small" style="margin-top:8px"></div>
    </div>
  </div>

<script>
/* =========================
   Dados das aulas / módulos
   ========================= */
const LESSONS = [
  // módulo 1
  { id:1, module:1, title:"Apresentações & Cumprimentos", text:"Frases formais e informais para cumprimentar e apresentar-se." },
  { id:2, module:1, title:"Alfabeto & Soletração", text:"Como soletrar o seu nome e entender letras." },
  { id:3, module:1, title:"Rotina Matinal", text:"Frases para descrever a sua rotina diária." },

  // módulo 2
  { id:4, module:2, title:"Carreira & Profissões", text:"Vocabulário profissional e expressões para o local de trabalho." },
  { id:5, module:2, title:"Viagens & Transporte", text:"Frases úteis no aeroporto, estação e mobilidade urbana." },
  { id:6, module:2, title:"Saúde & Emergências", text:"Como comunicar sintomas e pedir ajuda." },

  // módulo 3
  { id:7, module:3, title:"Compras & Serviços", text:"Frases para comprar, pedir serviços e pagar." },
  { id:8, module:3, title:"Comunicação Avançada", text:"Expressões para conversas mais longas e fluidez." },
  { id:9, module:3, title:"Teste Final de Fluência", text:"Atividades para avaliar a fluência e preparação oral." }
];

/* ===== códigos válidos (preparados) ===== */
const VALID_CODES = [
  "PRC-2025-001",
  "PRC-2025-002",
  "ING-2025-001",
  "ING-2025-002"
];

/* ===== selectors ===== */
const modulesContainer = document.getElementById('modulesContainer');
const lessonTitle = document.getElementById('lessonTitle');
const lessonMeta = document.getElementById('lessonMeta');
const lessonText = document.getElementById('lessonText');
const btnShowValidate = document.getElementById('btnShowValidate');
const modalBackdrop = document.getElementById('modalBackdrop');
const closeModal = document.getElementById('closeModal');
const submitCode = document.getElementById('submitCode');
const codeInput = document.getElementById('codeInput');
const modalMsg = document.getElementById('modalMsg');
const validationStatus = document.getElementById('validationStatus');
const btnDashboard = document.getElementById('btnDashboard');
const fekaUserLabel = document.getElementById('fekaUserLabel');
const btnReadAloud = document.getElementById('btnReadAloud');
const btnMarkComplete = document.getElementById('btnMarkComplete');
const teacherAnim = document.getElementById('teacherAnim');
const teacherBody = document.getElementById('teacherBody');
const teacherBubble = document.getElementById('teacherBubble');

/* ===== estado local ===== */
let state = {
  currentLessonIdx: null,
  ing_validado: localStorage.getItem('ing_validado') === 'true',
  feka_user: null,
  userCourses: []
};

/* ===== inicialização do user (feka_user) ===== */
function initUser(){
  const raw = localStorage.getItem('feka_user');
  if(raw){
    try {
      state.feka_user = JSON.parse(raw);
    } catch(e){
      state.feka_user = null;
    }
  }
  if(!state.feka_user){
    // cria um user padrão se não existir (pode ser substituído por login real)
    state.feka_user = {
      nome: "Aluno FEKA",
      email: "",
      cursos: [] // ex: ['procurement','ingles']
    };
    localStorage.setItem('feka_user', JSON.stringify(state.feka_user));
  }
  fekaUserLabel.textContent = state.feka_user.nome;
  // sincroniza user cursos com flags locais
  if(localStorage.getItem('procurement_validado') === 'true' && !state.feka_user.cursos.includes('procurement')) state.feka_user.cursos.push('procurement');
  if(localStorage.getItem('ing_validado') === 'true' && !state.feka_user.cursos.includes('ingles')) state.feka_user.cursos.push('ingles');
  localStorage.setItem('feka_user', JSON.stringify(state.feka_user));
}

/* ===== render accordion dos módulos ===== */
function renderModules(){
  modulesContainer.innerHTML = '';
  const modulesGrouped = {};
  LESSONS.forEach(l => {
    if(!modulesGrouped[l.module]) modulesGrouped[l.module] = {module:l.module, lessons:[], levelTitle: `MÓDULO ${l.module}`};
    modulesGrouped[l.module].lessons.push(l);
  });

  Object.values(modulesGrouped).forEach(mod => {
    const moduleEl = document.createElement('div');
    moduleEl.className = 'module';

    const header = document.createElement('div');
    header.className = 'module-header';
    header.innerHTML = `<div><span class="module-title">${mod.levelTitle}</span></div><div><i class="fa-solid fa-chevron-down"></i></div>`;
    moduleEl.appendChild(header);

    const body = document.createElement('div');
    body.className = 'module-body';

    mod.lessons.forEach(lesson => {
      const li = document.createElement('div');
      li.className = 'lesson-item';
      li.dataset.lessonId = lesson.id;
      li.innerHTML = `<div><strong>${lesson.id}.</strong> ${lesson.title}</div><div><button class="btn link btn-audio" title="Ouvir aula"><i class="fa-solid fa-volume-high"></i></button></div>`;
      // click on lesson area
      li.addEventListener('click', (ev) => {
        // avoid triggering when pressing the audio button
        if(ev.target.closest('.btn-audio')) return;
        selectLesson(lesson.id); 
        // mark active
        body.querySelectorAll('.lesson-item').forEach(x=>x.classList.remove('active'));
        li.classList.add('active');
      });
      // audio button
      li.querySelector('.btn-audio').addEventListener('click', (ev) => {
        ev.stopPropagation();
        speakLesson(lesson);
      });
      body.appendChild(li);
    });

    moduleEl.appendChild(body);
    modulesContainer.appendChild(moduleEl);

    // accordion toggle
    header.addEventListener('click', () => {
      const showing = body.style.display === 'block';
      // collapse any other open module to keep tidy
      document.querySelectorAll('.module-body').forEach(b => b.style.display = 'none');
      document.querySelectorAll('.module-header i').forEach(i => i.style.transform = 'rotate(0deg)');
      if(!showing){
        body.style.display = 'block';
        header.querySelector('i').style.transform = 'rotate(180deg)';
      } else {
        body.style.display = 'none';
        header.querySelector('i').style.transform = 'rotate(0deg)';
      }
    });
  });
}

/* ===== selecionar / carregar aula ===== */
function selectLesson(lessonId){
  const L = LESSONS.find(x => x.id === Number(lessonId));
  if(!L) return;
  state.currentLessonIdx = LESSONS.indexOf(L);
  lessonTitle.textContent = L.title;
  lessonMeta.textContent = `Módulo ${L.module} • Aula ${L.id}`;
  lessonText.textContent = L.text;
  btnReadAloud.disabled = false;
  btnMarkComplete.disabled = false;
}

/* ===== TTS (voz masculina preferida) ===== */
function getPreferredMaleVoice(){
  const voices = window.speechSynthesis.getVoices();
  if(!voices || voices.length === 0) return null;
  // Try find a male-sounding voice by common names
  const preferredNames = ['Male','Daniel','David','John','Alex','James','Zeke','Allan','Paul','Mark','Tom','Tomás','Diego','Diego Male','Google UK English Male','Google US English','Microsoft David','en-US'];
  for(const name of preferredNames){
    const v = voices.find(voice => voice.name && voice.name.toLowerCase().includes(name.toLowerCase()));
    if(v) return v;
  }
  // fallback to any en voice
  const en = voices.find(v => v.lang && v.lang.startsWith('en'));
  if(en) return en;
  return voices[0];
}

function speakText(text){
  if(!('speechSynthesis' in window)){
    alert('TTS não suportado neste browser.');
    return;
  }
  const utterance = new SpeechSynthesisUtterance(text);
  // try to select male voice
  const voice = getPreferredMaleVoice();
  if(voice) utterance.voice = voice;
  // prefer en-US or en
  utterance.lang = utterance.voice ? utterance.voice.lang : 'en-US';
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utterance);
}

/* speak current lesson */
function speakLesson(lesson){
  const text = `${lesson.title}. ${lesson.text}`;
  speakText(text);
}

/* ===== modal handlers ===== */
btnShowValidate.addEventListener('click', () => {
  codeInput.value = '';
  modalMsg.textContent = '';
  modalBackdrop.style.display = 'flex';
  codeInput.focus();
});
closeModal.addEventListener('click', () => { modalBackdrop.style.display = 'none'; });
modalBackdrop.addEventListener('click', (e) => {
  if(e.target === modalBackdrop) modalBackdrop.style.display = 'none';
});

/* ===== validar código ===== */
submitCode.addEventListener('click', validateCode);
codeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') validateCode(); });

function validateCode(){
  const code = (codeInput.value || '').trim().toUpperCase();
  if(!code){ modalMsg.textContent = 'Insere um código.'; return; }
  if(!VALID_CODES.includes(code)){
    modalMsg.textContent = 'Código inválido. Verifica e tenta novamente.';
    return;
  }
  // accepted: mark ing_validado (for this course) and update feka_user
  localStorage.setItem('ing_validado', 'true');
  state.ing_validado = true;
  // update feka_user cursos
  const raw = localStorage.getItem('feka_user');
  let user = raw ? JSON.parse(raw) : { nome:'Aluno FEKA', email:'', cursos:[] };
  if(!Array.isArray(user.cursos)) user.cursos = [];
  if(!user.cursos.includes('ingles')) user.cursos.push('ingles');
  localStorage.setItem('feka_user', JSON.stringify(user));
  state.feka_user = user;
  fekaUserLabel.textContent = user.nome;

  modalMsg.textContent = '✅ Código aceite — curso validado!';
  validationStatus.textContent = 'Curso validado ✅';
  btnDashboard.style.display = 'inline-block';
  // close modal after short delay
  setTimeout(()=>{ modalBackdrop.style.display = 'none'; },700);
}

/* ===== dashboard button ===== */
btnDashboard.addEventListener('click', () => {
  // single dashboard for all users
  window.location.href = 'dashboard.html';
});

/* ===== read aloud / teacher bubble interactions ===== */
btnReadAloud.addEventListener('click', () => {
  if(state.currentLessonIdx === null) return;
  const L = LESSONS[state.currentLessonIdx];
  speakLesson(L);
});

// teacher floating
teacherBody.addEventListener('click', () => {
  if(state.currentLessonIdx !== null){
    const L = LESSONS[state.currentLessonIdx];
    teacherBubble.textContent = `Vou ler: ${L.title}`;
    teacherBubble.style.display = 'block';
    speakLesson(L);
    setTimeout(()=>teacherBubble.style.display='none',3000);
  } else {
    teacherBubble.textContent = 'Seleciona uma aula à esquerda para eu ler.';
    teacherBubble.style.display = 'block';
    setTimeout(()=>teacherBubble.style.display='none',3000);
  }
});

/* ===== inicialização UI ===== */
function updateValidationUI(){
  if(localStorage.getItem('ing_validado') === 'true'){
    validationStatus.textContent = 'Curso validado ✅';
    btnDashboard.style.display = 'inline-block';
  } else {
    validationStatus.textContent = 'Curso não validado';
    btnDashboard.style.display = 'none';
  }
}

function boot(){
  initUser();
  renderModules();
  updateValidationUI();
  // If there is a previously selected lesson index saved, you could restore here (optional)
}

/* run on voiceschanged to ensure voices loaded */
window.speechSynthesis.onvoiceschanged = function(){ /* no-op, helps browsers load voices */ };

window.addEventListener('load', boot);
</script>
</body>
</html>
